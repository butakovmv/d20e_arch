# ADR4. Оптимизация обращений к сервису пользователей в сценариях авторизации

| Актуальное | Принято 22.07.23                          |
|------------|-------------------------------------------|
| Участники  | Бутаков М.В.                              |
| Изменения  | 21.07.23 - Создано<br/>22.07.23 - Принято |

Задача: Выработать решение, сокращающее количество обращений к сервису пользователей

<!-- TOC -->
* [ADR3. Развертывание](#adr3-развертывание)
	* [Факторы влияющие на размещение](#факторы-влияющие-на-размещение)
	* [Решения](#решения)
	* [Диаграмма](#диаграмма)
	* [Последствия](#последствия)
<!-- TOC -->

## Проблема

Как видно из диаграмм последовательности, для большинства вызовов от лица аутентифицированного пользователя происходит
вызов под-сценария авторизации - определения прав.

Нагрузочные тесты показывают, что это самое частое место обращений, здесь происходит обращение к БД и при времени
отработки Х мс от обращения к сервису до выдачи ответа оно вносит суммарный вклад во время ответа системы Y%. Также при
росте нагрузки пользователей до значения А, происходит значительный рост 95% процентиля времени ответа.

Вышесказанное влияет на отзывчивость и производительность.

Необходимо выработать способы снизить количество подобных обращений или уменьшить
время их обработки.

## Факторы влияющие на выбор

В пике к системе обращается около 300 пользователей, пиковая частота до 50 запросов в секунду.

## Варианты

1. Использовать кеш пользователей на стороне сервиса пользователей.<br/>
   Срок жизни кеша - около 1-2 минут.
	1. 50rps * 60sec / 300 уникальных пользователей = каждый 10-й запрос будет браться не из кеша
	2. 50rps * 120sec / 300 уникальных пользователей = каждый 20-й запрос будет браться не из кеша

	 Одно обращение к кешу вместо одного обращения к БД даст экономию около 80% времени.
2. Использовать JWT-токен с кешем данных пользователя с аналогичным сроком жизни (поле exp) и аналогичным вкладом в
   экономию. Обновлять JWT и проверять нали

| JWT                                                                  | Кеш                                |
|----------------------------------------------------------------------|------------------------------------|
| меньше ресурсов - не требуется организация кеша на бэкенде           | меньше объем пересылаемого трафика |
| меньше точек отказа                                                  |                                    |
| не требуется мониторинг и настройка реагирования на инциденты        |                                    |
| отсутствует проблема вытеснения старых записей при переполнении кеша |                                    |

С учетом того, что в системе пользователи не банятся и не удаляются, а единственное появление ограничений в правах -
потеря доступа к игровой комнате при ее покидании покидать игровые комнаты (решается сервисом игровых комнат, можно
принудительно выдать новый токен), решение с JWT выглядит более подходящим.

## Решения

1. Использовать JWT для "кеширования" прав пользователя.
2. Внести изменения в настройку кеширования в API Gateway для исключения из кеширования поля HTTP-запросов в котором
   передается JWT, чтобы исключить ситуацию передачи токена из кеша посторонним пользователям.
3. Провести повторный нагрузочный тест, оценить фактическое влияние на отзывчивость и производительность, сравнить с
   расчетным влиянием.
